<Project DefaultTargets="Test" ToolsVersion="15.0">

  <Import Project="Directory.Build.props" />

  <PropertyGroup>
    <TestRunDir>$(RepoDir)/test/testrun</TestRunDir>
  </PropertyGroup>

  <PropertyGroup>
    <SamplePkgVersion>1.0.0</SamplePkgVersion>
    <SamplePkgDir>$(TestRunDir)/pkgs</SamplePkgDir>
  </PropertyGroup>

  <Target Name="PackLib">
    <RemoveDir Directories="$(TestRunDir)/pkgs" />
    <Exec Command='dotnet pack -o "$(SamplePkgDir)" /p:Version=$(SamplePkgVersion)' WorkingDirectory="$(RepoDir)/test/examples/sample1-dotnet" />
    <Exec Command='dotnet pack -o "$(SamplePkgDir)" /p:Version=$(SamplePkgVersion)' WorkingDirectory="$(RepoDir)/test/examples/sample2-dotnetcore" />
    <Exec Command='dotnet pack -o "$(SamplePkgDir)" /p:Version=$(SamplePkgVersion)' WorkingDirectory="$(RepoDir)/test/examples/sample3-dotnetcore-1_6" />
  </Target>

  <Target Name="Test" DependsOnTargets="PackLib">
    <RemoveDir Directories="$(TestRunDir)/out" />
    <MakeDir Directories="$(TestRunDir)/out" />
    <Copy SourceFiles="$(SamplePkgDir)/Lib1.$(SamplePkgVersion).nupkg" DestinationFolder="$(TestRunDir)/out" />

    <RemoveDir Directories="$(TestRunDir)/sdk2" />
    <MakeDir Directories="$(TestRunDir)/sdk2" />
    <Copy SourceFiles="$(RepoDir)/test/usetool/tools.proj" DestinationFolder="$(TestRunDir)/sdk2" />

    <WriteLinesToFile
        File="$(TestRunDir)/sdk2/nuget.config"
        Lines='
&lt;configuration&gt;
 &lt;packageSources&gt;
    &lt;add key="local" value="$(NupkgsDir)" /&gt;
 &lt;/packageSources&gt;
&lt;/configuration&gt;
'
        />

    <Exec Command='dotnet restore --packages packages /p:PkgUnderTestVersion=$(PkgUnderTestVersion)' WorkingDirectory="$(TestRunDir)/sdk2" />
    <Exec Command='dotnet mergenupkg --source "$(TestRunDir)/out/Lib1.$(SamplePkgVersion).nupkg" --other "$(SamplePkgDir)/Lib3.$(SamplePkgVersion).nupkg" --framework netstandard1.6 ' WorkingDirectory="$(TestRunDir)/sdk2" />
  </Target>

</Project>
